<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>PhiFlow — Consciousness Compiler</title>
    <style>
        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        body {
            background: #0a0a0f;
            color: #e0e0ff;
            font-family: 'Courier New', monospace;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            align-items: center;
            padding: 40px 20px;
        }

        h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #b488ff, #61efce);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 6px;
            letter-spacing: 0.05em;
        }

        .subtitle {
            color: #7a7aaa;
            font-size: 0.85rem;
            margin-bottom: 36px;
        }

        .grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            width: 100%;
            max-width: 900px;
        }

        .panel {
            background: #12121f;
            border: 1px solid #2a2a4a;
            border-radius: 12px;
            padding: 20px;
        }

        .panel h2 {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 0.12em;
            color: #7a7aaa;
            margin-bottom: 12px;
        }

        #log {
            grid-column: 1 / -1;
            min-height: 220px;
            font-size: 0.82rem;
            line-height: 1.7;
            color: #a0ffc0;
            overflow-y: auto;
            max-height: 340px;
        }

        .metric {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 8px 0;
            border-bottom: 1px solid #1e1e35;
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            color: #7a7aaa;
            font-size: 0.8rem;
        }

        .metric-value {
            font-size: 1.1rem;
            font-weight: bold;
            color: #b488ff;
        }

        .phi-bar {
            width: 100%;
            height: 6px;
            background: #1e1e35;
            border-radius: 3px;
            margin-top: 10px;
            overflow: hidden;
        }

        .phi-fill {
            height: 100%;
            background: linear-gradient(90deg, #b488ff, #61efce);
            border-radius: 3px;
            transition: width 0.4s ease;
            width: 0%;
        }

        .intention-stack {
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .intention-item {
            background: #1e1e35;
            border-left: 3px solid #b488ff;
            padding: 6px 10px;
            border-radius: 0 6px 6px 0;
            font-size: 0.8rem;
            color: #c8c8ff;
            animation: fadeIn 0.3s ease;
        }

        .resonance-item {
            background: #121f1a;
            border-left: 3px solid #61efce;
            padding: 6px 10px;
            border-radius: 0 6px 6px 0;
            font-size: 0.8rem;
            color: #61efce;
            animation: fadeIn 0.3s ease;
        }

        .run-btn {
            background: linear-gradient(135deg, #b488ff, #61efce);
            border: none;
            border-radius: 8px;
            color: #0a0a0f;
            cursor: pointer;
            font-family: inherit;
            font-size: 0.9rem;
            font-weight: bold;
            letter-spacing: 0.08em;
            padding: 14px 40px;
            margin-bottom: 28px;
            transition: opacity 0.2s;
        }

        .run-btn:hover {
            opacity: 0.85;
        }

        .run-btn:active {
            opacity: 0.7;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateX(-6px);
            }

            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .witness-pulse {
            animation: pulse 0.6s ease;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(180, 136, 255, 0.6);
            }

            70% {
                box-shadow: 0 0 0 14px rgba(180, 136, 255, 0);
            }

            100% {
                box-shadow: 0 0 0 0 rgba(180, 136, 255, 0);
            }
        }
    </style>
</head>

<body>

    <h1>φ PhiFlow</h1>
    <p class="subtitle">Consciousness Compiler — WebAssembly Host</p>

    <button class="run-btn" onclick="runPhiFlow()">▶ Run Program</button>

    <div class="grid">
        <div class="panel" id="log-panel">
            <h2>Execution Log</h2>
            <div id="log">Waiting to run…</div>
        </div>

        <div class="panel">
            <h2>Coherence</h2>
            <div class="metric">
                <span class="metric-label">Score</span>
                <span class="metric-value" id="coherence-val">—</span>
            </div>
            <div class="metric">
                <span class="metric-label">φ⁻¹ target</span>
                <span class="metric-value" style="color:#61efce">0.6180</span>
            </div>
            <div class="phi-bar">
                <div class="phi-fill" id="phi-fill"></div>
            </div>
        </div>

        <div class="panel">
            <h2>Intention Stack</h2>
            <div class="intention-stack" id="intention-stack">
                <span style="color:#3a3a5a; font-size:0.8rem">No active intentions</span>
            </div>
        </div>

        <div class="panel">
            <h2>Resonance Field</h2>
            <div id="resonance-field">
                <span style="color:#3a3a5a; font-size:0.8rem">Field empty</span>
            </div>
        </div>
    </div>

    <script>
        // === PhiFlow Browser Host ===
        // Tries to load output.wat via fetch (requires HTTP server).
        // Falls back to animated simulation if not served.
        //
        // To run with real WASM:
        //   cargo run --example phiflow_wasm   # generates output.wat
        //   python -m http.server 8080          # serve from PhiFlow directory
        //   open http://localhost:8080/examples/phiflow_browser.html

        const PHI_INV = 0.6180339887;
        const STRING_BASE = 0x100; // must match wasm.rs STRING_BASE

        let coherenceScore = 0.618;
        const resonanceField = [];
        const intentionStack = [];
        const witnessLog = [];

        const logEl = document.getElementById('log');
        const cEl = document.getElementById('coherence-val');
        const phiFill = document.getElementById('phi-fill');
        const intentEl = document.getElementById('intention-stack');
        const resonEl = document.getElementById('resonance-field');

        function log(msg, color = '#a0ffc0') {
            const d = document.createElement('div');
            d.style.color = color;
            d.textContent = msg;
            logEl.appendChild(d);
            logEl.scrollTop = logEl.scrollHeight;
        }

        function updateCoherence(val) {
            coherenceScore = val;
            cEl.textContent = val.toFixed(4);
            phiFill.style.width = (val * 100) + '%';
        }

        function renderIntentions() {
            intentEl.innerHTML = intentionStack.length === 0
                ? '<span style="color:#3a3a5a;font-size:0.8rem">No active intentions</span>'
                : intentionStack.map(i => `<div class="intention-item">⟡ ${i}</div>`).join('');
        }

        function renderResonance() {
            resonEl.innerHTML = resonanceField.length === 0
                ? '<span style="color:#3a3a5a;font-size:0.8rem">Field empty</span>'
                : resonanceField.map(v => `<div class="resonance-item">≋ ${v.toFixed(4)}</div>`).join('');
        }

        // Read UTF-8 string from WASM linear memory
        function readWasmString(memory, offset, length) {
            if (!memory || offset < STRING_BASE || length <= 0) return null;
            try {
                return new TextDecoder('utf-8').decode(new Uint8Array(memory.buffer, offset, length));
            } catch (_) { return null; }
        }

        // Build WebAssembly import object — memory resolved lazily after instantiation
        function makeImports(getExports) {
            return {
                phi: {
                    witness: (operandOrOffset) => {
                        document.getElementById('log-panel').classList.add('witness-pulse');
                        setTimeout(() => document.getElementById('log-panel').classList.remove('witness-pulse'), 700);
                        let label = `r${operandOrOffset}`;
                        const exp = getExports();
                        if (exp && exp.memory && exp.string_len) {
                            const len = exp.string_len.value;
                            if (len > 0 && operandOrOffset >= STRING_BASE) {
                                const s = readWasmString(exp.memory, operandOrOffset, len);
                                if (s) label = `"${s}"`;
                            }
                        }
                        const note = `[WITNESS] ${label}  coherence=${coherenceScore.toFixed(4)}  intent=${intentionStack.at(-1) ?? 'none'}`;
                        witnessLog.push(note);
                        log('  ' + note, '#ffd700');
                        return coherenceScore;
                    },

                    coherence: () => {
                        coherenceScore = coherenceScore * 0.9 + PHI_INV * 0.1;
                        updateCoherence(coherenceScore);
                        return coherenceScore;
                    },

                    resonate: (value) => {
                        resonanceField.push(value);
                        log(`  [RESONATE] ${value.toFixed(4)} → field depth ${resonanceField.length}`, '#61efce');
                        renderResonance();
                    },

                    intention_push: (offsetOrLen) => {
                        let name = `intent_${offsetOrLen}`;
                        const exp = getExports();
                        if (exp && exp.memory && exp.string_len) {
                            const len = exp.string_len.value;
                            if (len > 0 && offsetOrLen >= STRING_BASE) {
                                const s = readWasmString(exp.memory, offsetOrLen, len);
                                if (s) name = s;
                            }
                        }
                        intentionStack.push(name);
                        log(`  [INTENTION ▶] push "${name}" depth=${intentionStack.length}`, '#b488ff');
                        renderIntentions();
                    },

                    intention_pop: () => {
                        const popped = intentionStack.pop();
                        log(`  [INTENTION ◀] pop "${popped}" depth=${intentionStack.length}`, '#b488ff');
                        renderIntentions();
                    }
                }
            };
        }

        // --- Attempt real WASM (requires HTTP server + wabt CDN) ---
        async function tryRealWasm() {
            const resp = await fetch('output.wat').catch(() => null);
            if (!resp || !resp.ok) return null;
            const watText = await resp.text();

            // Load wabt from CDN
            await new Promise((res, rej) => {
                const s = document.createElement('script');
                s.src = 'https://cdn.jsdelivr.net/npm/wabt@1.0.36/index.js';
                s.onload = res; s.onerror = rej;
                document.head.appendChild(s);
            });
            const wabt = await WabtModule();
            const parsed = wabt.parseWat('output.wat', watText, { mutable_globals: true });
            const { buffer } = parsed.toBinary({ log: false });
            parsed.destroy();

            let wasmExports = null;
            const imports = makeImports(() => wasmExports);
            const { instance } = await WebAssembly.instantiate(buffer, imports);
            wasmExports = instance.exports;
            return wasmExports;
        }

        // --- Simulation fallback ---
        async function runSimulation() {
            log('(Simulation — serve via `python -m http.server 8080` for real WASM)', '#4a4a6a');
            log('');
            await delay(300);

            const phi = makeImports(() => null).phi;
            phi.intention_push(7); await delay(400);
            phi.coherence(); await delay(300);
            phi.witness(0); await delay(400);
            phi.resonate(84.0); await delay(300);
            phi.intention_pop(); await delay(300);
            const final = phi.coherence(); await delay(200);
            return { result: 84.0, source: 'simulation' };
        }

        async function runPhiFlow() {
            logEl.innerHTML = '';
            resonanceField.length = intentionStack.length = witnessLog.length = 0;
            updateCoherence(0.618);
            renderIntentions(); renderResonance();

            log('=== PhiFlow WASM Host ===', '#e0e0ff');
            log('');

            let result, source;
            try {
                log('Attempting real WASM…', '#7a7aaa');
                const exp = await tryRealWasm();
                if (exp && exp.phi_run) {
                    log('✓ Compiled output.wat → real WASM binary', '#61efce');
                    log('');
                    result = exp.phi_run();
                    source = 'WASM';
                } else throw new Error('no phi_run');
            } catch (_) {
                const sim = await runSimulation();
                result = sim.result; source = sim.source;
            }

            log('');
            log(`Result:    Number(${result})`, '#ffffff');
            log(`Source:    ${source}`, '#7a7aaa');
            log(`Coherence: ${coherenceScore.toFixed(4)} (φ⁻¹ = ${PHI_INV.toFixed(4)})`, '#ffd700');
            log(`Witness:   ${witnessLog.length} entries`, '#7a7aaa');
            log('');
            log('=== Done ===', '#e0e0ff');
        }

        function delay(ms) { return new Promise(r => setTimeout(r, ms)); }
    </script>
</body>

</html>