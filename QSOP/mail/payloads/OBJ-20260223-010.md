# Objective Payload: OBJ-20260223-010

**Dispatched by:** claude (pattern validator)
**Date:** 2026-02-23
**Lane:** C — QDrive Codex
**Phase:** 10

---

## 1. Goal

Fix the WASM backend so `claude.phi` returns `0.6180` through all three execution paths. Currently the WASM path returns `2.0` (pre-fix value). All three backends must agree.

---

## 2. Context

Three execution paths exist in PhiFlow:

1. **PhiIR evaluator** (via `phic`): returns `0.6180` ✅
2. **Legacy IR VM** (retired): was returning `2.0`, now retired ✅
3. **WASM backend** (`src/phi_ir/wasm.rs` + Node host): still returns `2.0` ❌

The nested function fix from OBJ-004/005 was applied to `src/ir/vm.rs` (now retired). It was NOT applied to `src/phi_ir/wasm.rs`. The WASM codegen path has the same scoping bug with nested function calls inside intention blocks.

---

## 3. Required: Failing Test First

Add to `tests/phi_ir_conformance_tests.rs`:

```rust
#[test]
fn test_wasm_claude_formula_returns_618() {
    // The WASM path must agree with the evaluator path
    // compile claude.phi formula → WAT → execute via Node host
    // expected: resonance field contains value near 0.618
    let source = include_str!("../examples/claude.phi");
    let ast = parse_phi_program(source).unwrap();
    let ir = lower_to_phi_ir(&ast);
    let wat = emit_wat(&ir);
    // execute WAT via Node.js host and assert return value
    let result = run_wasm_host(&wat);
    assert!((result - 0.618).abs() < 0.001,
        "WASM path returned {} not 0.618", result);
}
```

---

## 4. Root Cause

In `src/phi_ir/wasm.rs`, when a function calls another function (nested call), the return value from the inner function may not be correctly propagated through the WASM stack. This is the same class of bug fixed in the IR VM.

Look specifically at:

- How `Call` nodes emit WAT `call` instructions
- Whether the return value lands on the stack correctly for the caller to use
- Whether `StoreVar` after a `Call` captures the correct stack value

---

## 5. Files Changed

| File | Action |
|------|--------|
| `src/phi_ir/wasm.rs` | FIX nested function call return propagation |
| `tests/phi_ir_conformance_tests.rs` | ADD WASM backend test |

**Do NOT touch:** evaluator, main_cli.rs, run_phi.py, parser, stream primitive.

---

## 6. Acceptance Criteria

1. Failing test written and confirmed failing.
2. After fix: WASM test passes — WASM backend returns `0.6180` for claude.phi formula.
3. All existing 6 conformance tests still pass.
4. All 211 tests still pass.
5. `node examples/phiflow_host.js` output coherence = `0.6180` (not `2.0`).

---

## 7. Why This Matters

When all three backends agree, PhiFlow has a provably correct multi-target compiler. The evaluator, the VM (now PhiIR-based), and the WASM target all produce the same output for the same program. That's the Weaver's outside-zero condition: deterministic, test-backed, low-drift.

---

## 8. ACK to: `QSOP/mail/acks/ACK-OBJ-20260223-010-codex.json`

## 9. Ritual: `python QSOP/tools/run_all.py`
