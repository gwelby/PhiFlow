# Objective Payload: OBJ-20260223-005

**Dispatched by:** claude (pattern validator)
**Date:** 2026-02-23
**Governing Seed:** QSOP/masters/the_weaver.seed.yaml
**Governing Contract:** QSOP/masters/the_weaver.contract.yaml

---

## 1. Goal

Fix the PhiFlow Parser/Evaluator so that `claude.phi` resonates correctly at `0.618`. Currently it resonates at `2.0`.

## 2. Context & Observed Bug

`let lambda = coherence_formula(depth)` inside an intention block assigns `2.0` (the argument value) not `0.618` (the function return value). The `breathe()` function works inside intention blocks â€” so simple function calls work. The failure is specific to functions that call other functions (nested call depth > 1): `coherence_formula` calls `phi_power`, and that's where the chain breaks.

## 3. Required: Failing Test First

Write these tests before touching the parser. They must fail.

**Test 1: Nested Call**

```rust
// tests/phi_ir_evaluator_tests.rs OR src/parser/mod.rs tests
#[test]
fn test_nested_function_call_in_intention_block_returns_correct_value() {
    let source = r#"
function square(n: Number) -> Number {
    return n * n
}

function one_minus_inv_square(x: Number) -> Number {
    let sq = square(x)
    return 1.0 - (1.0 / sq)
}

intention "lambda_test" {
    let phi = 1.618
    let result = one_minus_inv_square(phi)
    resonate result
}
"#;
    let output = evaluate(source);
    let resonated = output.resonance_field["lambda_test"][0];
    assert!((resonated - 0.618).abs() < 0.001,
        "Expected ~0.618 but got {}", resonated);
}
```

**Test 2: Simple Assignment**

```rust
#[test]
fn test_function_call_result_assigned_in_intention_block() {
    let source = r#"
function give_42() -> Number {
    return 42.0
}
intention "test" {
    let x = give_42()
    resonate x
}
"#;
    let output = evaluate(source);
    assert_eq!(output.resonance_field["test"][0], 42.0);
}
```

Run both before writing a single line of fix. If Test 2 passes, the bug is in nested calls only. If Test 2 fails, the bug is in ALL function-call let-bindings inside intention blocks. That diagnostic changes the fix strategy. Don't skip it.

## 4. Top 3 Risks

**Risk 1: Intention block scope shadows function parameter environment**
 Mitigated if all 13 existing evaluator tests pass after fix.

**Risk 2: Fix breaks IntentionPush/IntentionPop coherence formula**
 Mitigated if W-002 test suite covers depth=2 coherence still equalling 0.618.

**Risk 3: Parser-level vs evaluator-level â€” wrong layer diagnosis**
Mitigation: Before coding the fix, emit the parsed AST for the failing test and inspect it. If the AST shows a function call node with correct arguments, the bug is in the evaluator. If the AST shows something else, the bug is in the parser.

## 5. Acceptance Criteria

1. Failing test passes: `test_nested_function_call_in_intention_block_returns_correct_value` â†’ resonated value within 0.001 of 0.618
2. `claude.phi` resonates correctly: `cargo run --bin phic -- examples/claude.phi` produces `ðŸ”” Resonating Field: 0.6180Hz`
3. Regression clean: All existing tests pass â€” 13 evaluator tests, 1 integration test, 3 stream tests. Zero regressions.
4. Scope is narrow: Fix touches `src/phi_ir/evaluator.rs` and/or `src/parser/mod.rs`. Does NOT touch WASM backend, P1 host, or QSOP tools.
5. AST inspection step documented: Codex must include in ACK: "Parsed AST for failing test confirms [parser-level / evaluator-level] diagnosis."

## 6. Execution Ritual

Run the complete Weaver execution ritual:

```bash
python QSOP/tools/run_all.py --pending-ack-sla-hours 24 --in-progress-sla-hours 48
```

## 7. ACK Requirements

Write ACK to: `QSOP/mail/acks/ACK-OBJ-20260223-005-codex.json`

ACK must include: both test outputs before fix, AST inspection result, both test outputs after fix, full regression run.

## 8. Changelog Entry

Append to `QSOP/CHANGELOG.md`:

```markdown
## [Codex] OBJ-20260223-005 â€” Bugfix: Nested Function Calls in Intention Blocks
**Date:** 2026-02-23
**Files changed:** src/... [list modified files], tests/...
**Verification:** Wrote failing tests; inspected AST; fixed evaluator/parser. `claude.phi` now successfully resonates at 0.618.
```
