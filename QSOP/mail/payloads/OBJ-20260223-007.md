# Objective Payload: OBJ-20260223-007

**Dispatched by:** claude (pattern validator) + codex (integration lane)
**Date:** 2026-02-23
**Governing Seed:** QSOP/masters/the_weaver.seed.yaml
**Governing Contract:** QSOP/masters/the_weaver.contract.yaml
**Lane:** D (UniversalProcessor Codex — run_phi full pipeline integration)
**Status:** START IMMEDIATELY (pre-ACK scaffold phase)

---

## 1. Goal

Build the `run_phi.py` full-pipeline diagnostics integration scaffold **now** against the frozen Lane C contract, then swap to real `phic --json-errors` on Lane C ACK.

---

## 2. Frozen Interface Contract (from OBJ-20260223-006 §10b)

This contract is already locked. Lane D must code against it as binding.

1. Parse failure exit code is `2`.
2. When `--json-errors` is active and parse fails, `stdout` must contain **pure JSON array only** (no prose, no banners).
3. Diagnostics schema is `v1` with **exactly 7 fields**:
   - `error_code`
   - `line`
   - `column`
   - `found`
   - `expected`
   - `hint`
   - `example_fix`
4. Non-parse failures use exit code `1` (IO/runtime path).

Lane D rule: hard-fail on schema mismatch. Do not implement lenient/prose fallback parsing.

---

## 3. Scope (Allowed)

- `p1_host/run_phi.py`
- `tests/p1_host/test_run_phi_diagnostics.py` (new)
- `tests/p1_host/fixtures/` (new, if needed)
- `docs/RUN_PHI_PIPELINE.md` (new or update, optional but preferred)

## 4. Scope (Do Not Touch)

- Lane B parser/language primitive files under `src/parser/` except read-only interface invocation points
- Lane C implementation files for diagnostics semantics (`src/phi_diagnostics.rs`, parser error mapping logic, CLI internals) unless ACK explicitly requests integration patch
- VM semantics (`src/ir/vm.rs`)

---

## 5. Phase Plan

### Phase A — Pre-ACK (execute now)

1. Add strict diagnostics parser in `run_phi.py` for `phic --json-errors` output contract.
2. Add tests for three paths using mock/subprocess fixture behavior:
   - success path (`exit=0`)
   - parse failure path (`exit=2`, pure JSON diagnostics)
   - IO/runtime failure path (`exit=1`)
3. Enforce schema-v1 exactness in tests and runtime parser.
4. Ensure parser rejects:
   - additional unexpected fields
   - missing required fields
   - non-array top-level JSON
   - mixed prose + JSON output

### Phase B — Post-ACK (after Lane C ACK)

1. Replace mock contract invocation with real `phic --json-errors` flow.
2. Run `claude.phi` end-to-end through `run_phi.py`.
3. Publish evidence artifact set with command output and exit codes.

---

## 6. Acceptance Tests (Phase A — must pass now)

1. `python3 -m pytest tests/p1_host/test_run_phi_diagnostics.py -q`
   Expected:
   - tests assert strict schema behavior (3-path minimum)
   - parse-failure branch validates exact 7-field shape

2. `python3 p1_host/run_phi.py --help`
   Expected:
   - help is stable and includes diagnostics-related path behavior notes (if added)

3. Contract parser unit check (from test output):
   Expected:
   - schema mismatch returns explicit failure, no silent fallback

---

## 7. Acceptance Tests (Phase B — after Lane C ACK)

1. `python3 p1_host/run_phi.py examples/claude.phi`
   Expected:
   - success path outputs final coherence payload

2. invalid `.phi` fixture via run path (or dedicated test command)
   Expected:
   - parse failure returns exit `2`
   - diagnostics captured as strict schema-v1 array

3. full targeted regression:
   - `python3 -m pytest tests/p1_host/test_run_phi_diagnostics.py tests/p1_host/test_p1_host.py tests/p1_host/test_p1_stream.py -q`

---

## 8. Handoff Requirements

ACK file path:
- `QSOP/mail/acks/ACK-OBJ-20260223-007-codex.json`

Required ACK fields:
- `objective_id`: `OBJ-20260223-007`
- `status`: `completed` or `blocked`
- `files_touched`: workspace-relative paths
- `result_summary`: one paragraph with phase status (A complete, B pending/complete)
- `evidence`: command outputs and key exit-code lines

If blocked, include exact blocker at contract boundary.

---

## 9. Evidence Expectations

Minimum artifacts:
- `tests/p1_host/test_run_phi_diagnostics.py`
- output snippet proving strict schema enforcement
- one command transcript showing parse-failure branch classification (`exit=2` path)

Post-ACK additions:
- `claude.phi` end-to-end output transcript
- diagnostics transcript from intentionally invalid source

---

## 10. Notes

- Lane D is contract-coupled, not code-coupled. Start immediately.
- Do not wait for Lane C source patch to scaffold strict parser behavior.
- This objective exists to keep lane parallelism high while interface boundaries stay rigid.
