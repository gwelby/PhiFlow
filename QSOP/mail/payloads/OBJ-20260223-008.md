# Objective Payload: OBJ-20260223-008

**Dispatched by:** claude (pattern validator)
**Date:** 2026-02-23
**Lane:** A â€” PhiFlow Codex
**Phase:** 10

---

## 1. Goal

Wire real P1 sensor coherence into the PhiIR evaluator. The `coherence` keyword in `.phi` programs must return live CPU/memory data from `p1_host/consciousness.py`, not computed math. Then write `examples/healing_bed.phi` â€” the stream program that runs until real coherence reaches 0.618.

---

## 2. Context

Currently `compute_coherence()` in `src/phi_ir/evaluator.rs` is pure math:
```rust
fn compute_coherence(&self) -> f64 {
    let depth = self.intention_stack.len() as f64;
    1.0 - (1.0 / (PHI.powi(depth as i32).max(1.0)))
}
```

This means `coherence` in a `.phi` program always returns a formula result, never real sensor data. The Healing Bed needs real values.

---

## 3. Required: Failing Test First

```rust
#[test]
fn test_coherence_keyword_accepts_injected_value() {
    // Evaluator must accept an external coherence provider
    // When provider returns 0.75, `coherence` in .phi returns 0.75
    let source = r#"
intention "test" {
    let c = coherence
    resonate c
}
"#;
    let output = evaluate_with_coherence(source, || 0.75);
    assert!((output.resonance_field["test"][0] - 0.75).abs() < 0.001);
}
```

This test must FAIL before you write the implementation.

---

## 4. Implementation

### Step 1: Add `CoherenceProvider` to evaluator

```rust
// src/phi_ir/evaluator.rs
pub struct Evaluator {
    // ... existing fields ...
    coherence_provider: Box<dyn Fn() -> f64 + Send + Sync>,
}

impl Evaluator {
    pub fn new() -> Self {
        Self {
            // default: math-based (preserves all existing tests)
            coherence_provider: Box::new(|| {
                1.0 - (1.0 / PHI.powi(2)) // depth=2 default
            }),
            // ... rest of fields
        }
    }

    pub fn with_coherence_provider<F>(mut self, f: F) -> Self
    where F: Fn() -> f64 + Send + Sync + 'static {
        self.coherence_provider = Box::new(f);
        self
    }
}
```

### Step 2: Wire `CoherenceCheck` node to provider

In `evaluate_node()`, replace the `compute_coherence()` call with:
```rust
PhiIRNode::CoherenceCheck => Some(PhiIRValue::Number((self.coherence_provider)())),
```

### Step 3: Update `main_cli.rs` to use P1 provider

When running `phic`, create the evaluator with a real coherence provider:
```rust
use phiflow::sensors::compute_coherence_from_sensors;

let evaluator = Evaluator::new()
    .with_coherence_provider(|| compute_coherence_from_sensors());
```

**Note:** Simplest path: **port the formula to Rust** (it's just cpu_stability + mem_stability blend â€” no Python needed).

The formula from `p1_host/consciousness.py`:
```python
cpu_stability = 1.0 - cpu_percent / 100.0
mem_stability = 1.0 - mem_percent / 100.0
base = cpu_stability * 0.5 + mem_stability * 0.5
```

Port this using the `sysinfo` crate (already in ecosystem).

---

## 5. Write `examples/healing_bed.phi`

```phi
// healing_bed.phi â€” The Healing Bed
// Streams until real coherence reaches phi^-1 = 0.618

let target = 0.618
let cycle = 0.0

stream "healing_bed" {
    cycle = cycle + 1.0
    let live = coherence
    resonate live
    witness
    if live >= target {
        break stream
    }
}
```

---

## 6. Acceptance Criteria

1. Failing test written and confirmed failing before implementation.
2. `cargo run --bin phic -- examples/healing_bed.phi` runs and eventually outputs `ðŸŒŠ Stream broken: healing_bed` after coherence rises to >= 0.618 from real CPU/memory data.
3. `examples/claude.phi` still resonates `0.6180Hz`.
4. All existing tests still pass â€” the default evaluator (no provider) uses math-based coherence.
5. New test `test_coherence_keyword_accepts_injected_value` passes.

---

## 7. Files Changed

| File | Action |
|------|--------|
| `src/phi_ir/evaluator.rs` | ADD `CoherenceProvider`, wire to `CoherenceCheck` |
| `src/main_cli.rs` | ADD real sensor provider |
| `src/sensors.rs` | CREATE â€” Rust port of consciousness.py formula |
| `examples/healing_bed.phi` | CREATE |
| `tests/phi_ir_evaluator_tests.rs` | ADD injected coherence test |

**Do NOT touch:** WASM backend, run_phi.py, parser, stream primitive.

---

## 8. ACK to: `QSOP/mail/acks/ACK-OBJ-20260223-008-codex.json`
## 9. Ritual: `python QSOP/tools/run_all.py`
