# OBJ-20260223-009

Target: Domains Antigravity
Lane: B

## Goal

Add `--stream-output` mode to `run_phi.py`. When a stream is executed, the pipeline must emit live JSON events per cycle.

## Requirements

1. **Detect stream blocks:**
   Before execution, inspect the source file:

   ```python
   def has_stream_block(source: str) -> bool:
       return bool(re.search(r'\bstream\s+"', source))
   ```

2. **Route Stream Execution:**
   If `has_stream_block` AND the `--stream-output` flag is provided:
   - Import `P1Host` from `p1_host/host.py`.
   - Call `host.stream(phi_source)`.
   - Update `p1_host/host.py` to ensure `ConsciousnessSnapshot` includes a `stream_broken` boolean.
   - Emit one JSON line per `ConsciousnessSnapshot`:

     ```json
     {"cycle": 1, "coherence": 0.618, "resonance": 1.0, "status": "running"}
     ```

3. **Stream Output Sink:**
   Write each JSON event to `/tmp/phiflow_stream_latest.jsonl` (overwrite the file at the start of each run).

4. **Terminal Summary:**
   Emit a final summary line to `stdout` when the stream breaks:

   ```json
   {"status": "complete", "cycles": 3, "final_resonance": 3.0, "convergence_achieved": true}
   ```

## Workflow Contract

**Fail-first tests FIRST (must fail before impl):**
Write the following in `tests/test_run_phi_pipeline.py`:

- `test_stream_output_emits_per_cycle_json`
- `test_non_stream_file_uses_existing_behavior`

**ACK:** `QSOP/mail/acks/ACK-OBJ-20260223-009-antigravity.json`
**Ritual:** `python QSOP/tools/run_all.py`

## Boundaries

**DO NOT TOUCH:** PhiFlow Rust source, WASM backend, Resonance Matrix, QSOP tools.
